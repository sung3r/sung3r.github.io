<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>m0nshaw&#39;s blog</title>
  <meta name="author" content="sung3r">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="m0nshaw&#39;s blog"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 4.2.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">m0nshaw&#39;s blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-user"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header logo">
  <h1>m0nshaw&#39;s blog<span class="blink-fast">|</span></h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">


		<i class="fa fa-heart blink-slow"></i>

		风吹🍂哪页读哪页📸🤗。

</div>    

		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/06/26/解决第一个UEFI-PWN——Accessing-the-Truth解题思路/" title="Pwn2Win CTF 2021 Accessing the Truth的解题思路">解决第一个UEFI PWN——Accessing the Truth解题思路</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-06-26  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/243007" target="_blank" rel="noopener">解决第一个UEFI PWN——Accessing the Truth解题思路</a></p>
<p>前段时间打了场PWN2WIN，期间遇到了这道BIOS题，正好来学习一下UEFI PWN<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622448541945-1622448541947.png" alt="title"></p>
<p>题目包含下列文件<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622448612466-1622448612467.png" alt="title"></p>
<h1 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h1><p><code>run.py</code>是题目给的启动脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python3 -u</span><br><span class="line">import random</span><br><span class="line">import string</span><br><span class="line">import subprocess</span><br><span class="line">import tempfile</span><br><span class="line"></span><br><span class="line">def random_string(n):</span><br><span class="line">    return &#39;&#39;.join(random.choice(string.ascii_lowercase) for _ in range(n))</span><br><span class="line"></span><br><span class="line">def check_pow(bits):</span><br><span class="line">    r &#x3D; random_string(10)</span><br><span class="line">    print(f&quot;hashcash -mb&#123;bits&#125; &#123;r&#125;&quot;)</span><br><span class="line">    solution &#x3D; input(&quot;Solution: \n&quot;).strip()</span><br><span class="line">    if subprocess.call([&quot;hashcash&quot;, f&quot;-cdb&#123;bits&#125;&quot;, &quot;-r&quot;, r, solution],</span><br><span class="line">                       cwd&#x3D;&quot;&#x2F;tmp&quot;,</span><br><span class="line">                       stdout&#x3D;subprocess.DEVNULL,</span><br><span class="line">                       stderr&#x3D;subprocess.DEVNULL) !&#x3D; 0:</span><br><span class="line">        raise Exception(&quot;Invalid PoW&quot;)</span><br><span class="line"></span><br><span class="line">#check_pow(25)</span><br><span class="line"></span><br><span class="line">fname &#x3D; tempfile.NamedTemporaryFile().name</span><br><span class="line"></span><br><span class="line">subprocess.call([&quot;cp&quot;, &quot;OVMF.fd&quot;, fname])</span><br><span class="line">try:</span><br><span class="line">  subprocess.call([&quot;chmod&quot;, &quot;u+w&quot;, fname])</span><br><span class="line">  subprocess.call([&quot;qemu-system-x86_64&quot;,</span><br><span class="line">                   &quot;-monitor&quot;, &quot;&#x2F;dev&#x2F;null&quot;,</span><br><span class="line">                   &quot;-m&quot;, &quot;64M&quot;,</span><br><span class="line">                   &quot;-drive&quot;, &quot;if&#x3D;pflash,format&#x3D;raw,file&#x3D;&quot; + fname, </span><br><span class="line">                   &quot;-drive&quot;, &quot;file&#x3D;fat:rw:contents,format&#x3D;raw&quot;,</span><br><span class="line">                   &quot;-net&quot;, &quot;none&quot;,</span><br><span class="line">                   &quot;-nographic&quot;], stderr&#x3D;subprocess.DEVNULL, timeout&#x3D;60)</span><br><span class="line">except:</span><br><span class="line">  pass</span><br><span class="line"></span><br><span class="line">subprocess.call([&quot;rm&quot;, &quot;-rf&quot;, fname])</span><br><span class="line">print(&quot;Bye!&quot;)</span><br></pre></td></tr></table></figure>

<p>注释掉pow，直接启动。启动起来是一个低权限用户的linux虚拟机，目标是获取根目录下flag.txt的内容，典型的内核题<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622449605453-1622449605456.png" alt="title"></p>
<p>仔细看启动命令，貌似没加载任何可疑的虚拟设备，排除掉QEMU逃逸<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622449718327-1622449718327.png" alt="title"></p>
<p>解开<code>contents/initramfs.cpio</code>，看到init文件。这里有一条<code>mount -t efivarfs efivarfs /sys/firmware/efi/efivars</code>，怀疑是UEFI PWN<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622449853859-1622449853860.png" alt="title"></p>
<p>另外，启动脚本里有60秒的timout，需要把这里干掉<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622450018868-1622450018871.png" alt="title"></p>
	

	</div>
  <a type="button" href="/2021/06/26/解决第一个UEFI-PWN——Accessing-the-Truth解题思路/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/243007" target="_blank" rel="noopener">解决第一个UEFI PWN——Accessing the Truth解题思路</a></p>
<p>前段时间打了场PWN2WIN，期间遇到了这道BIOS题，正好来学习一下UEFI PWN<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622448541945-1622448541947.png" alt="title"></p>
<p>题目包含下列文件<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622448612466-1622448612467.png" alt="title"></p>
<h1 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h1><p><code>run.py</code>是题目给的启动脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python3 -u</span><br><span class="line">import random</span><br><span class="line">import string</span><br><span class="line">import subprocess</span><br><span class="line">import tempfile</span><br><span class="line"></span><br><span class="line">def random_string(n):</span><br><span class="line">    return &#39;&#39;.join(random.choice(string.ascii_lowercase) for _ in range(n))</span><br><span class="line"></span><br><span class="line">def check_pow(bits):</span><br><span class="line">    r &#x3D; random_string(10)</span><br><span class="line">    print(f&quot;hashcash -mb&#123;bits&#125; &#123;r&#125;&quot;)</span><br><span class="line">    solution &#x3D; input(&quot;Solution: \n&quot;).strip()</span><br><span class="line">    if subprocess.call([&quot;hashcash&quot;, f&quot;-cdb&#123;bits&#125;&quot;, &quot;-r&quot;, r, solution],</span><br><span class="line">                       cwd&#x3D;&quot;&#x2F;tmp&quot;,</span><br><span class="line">                       stdout&#x3D;subprocess.DEVNULL,</span><br><span class="line">                       stderr&#x3D;subprocess.DEVNULL) !&#x3D; 0:</span><br><span class="line">        raise Exception(&quot;Invalid PoW&quot;)</span><br><span class="line"></span><br><span class="line">#check_pow(25)</span><br><span class="line"></span><br><span class="line">fname &#x3D; tempfile.NamedTemporaryFile().name</span><br><span class="line"></span><br><span class="line">subprocess.call([&quot;cp&quot;, &quot;OVMF.fd&quot;, fname])</span><br><span class="line">try:</span><br><span class="line">  subprocess.call([&quot;chmod&quot;, &quot;u+w&quot;, fname])</span><br><span class="line">  subprocess.call([&quot;qemu-system-x86_64&quot;,</span><br><span class="line">                   &quot;-monitor&quot;, &quot;&#x2F;dev&#x2F;null&quot;,</span><br><span class="line">                   &quot;-m&quot;, &quot;64M&quot;,</span><br><span class="line">                   &quot;-drive&quot;, &quot;if&#x3D;pflash,format&#x3D;raw,file&#x3D;&quot; + fname, </span><br><span class="line">                   &quot;-drive&quot;, &quot;file&#x3D;fat:rw:contents,format&#x3D;raw&quot;,</span><br><span class="line">                   &quot;-net&quot;, &quot;none&quot;,</span><br><span class="line">                   &quot;-nographic&quot;], stderr&#x3D;subprocess.DEVNULL, timeout&#x3D;60)</span><br><span class="line">except:</span><br><span class="line">  pass</span><br><span class="line"></span><br><span class="line">subprocess.call([&quot;rm&quot;, &quot;-rf&quot;, fname])</span><br><span class="line">print(&quot;Bye!&quot;)</span><br></pre></td></tr></table></figure>

<p>注释掉pow，直接启动。启动起来是一个低权限用户的linux虚拟机，目标是获取根目录下flag.txt的内容，典型的内核题<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622449605453-1622449605456.png" alt="title"></p>
<p>仔细看启动命令，貌似没加载任何可疑的虚拟设备，排除掉QEMU逃逸<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622449718327-1622449718327.png" alt="title"></p>
<p>解开<code>contents/initramfs.cpio</code>，看到init文件。这里有一条<code>mount -t efivarfs efivarfs /sys/firmware/efi/efivars</code>，怀疑是UEFI PWN<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622449853859-1622449853860.png" alt="title"></p>
<p>另外，启动脚本里有60秒的timout，需要把这里干掉<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/31/1622450018868-1622450018871.png" alt="title"></p>
	
	</div>
  <a type="button" href="/2021/06/26/解决第一个UEFI-PWN——Accessing-the-Truth解题思路/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/06/26/PWN掉一款小型开源OS——续篇：内核态PWN/" title="DefCon Quals 2021 coooinbase-kernel的解题思路">PWN掉一款小型开源OS——续篇：内核态PWN</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-06-26  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/242627" target="_blank" rel="noopener">PWN掉一款小型开源OS——续篇：内核态PWN</a></p>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/24/1621834179965-1621834179966.png" alt="title"><br>本篇文章是coooinbase这道题的内核态利用。作为上一篇文章<code>PWN掉一款小型开源OS——用户态利用</code>的续篇，本文将解决上文遗留下的一些问题，并分析从userland到kerneland的利用机会。</p>
<h1 id="遗留下的问题"><a href="#遗留下的问题" class="headerlink" title="遗留下的问题"></a>遗留下的问题</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> bson</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line"></span><br><span class="line">obj = &#123;</span><br><span class="line">    <span class="string">'CVC'</span>:<span class="number">111</span>,</span><br><span class="line">    <span class="string">'MON'</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">'YR'</span>: <span class="number">2021</span></span><br><span class="line">&#125;</span><br><span class="line">bs = bson.dumps(obj)</span><br><span class="line"></span><br><span class="line">bs = bs[:<span class="number">-1</span>]</span><br><span class="line">bs += <span class="string">b'\x02'</span></span><br><span class="line">bs += <span class="string">b'CC'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += p32(<span class="number">0x10</span>)</span><br><span class="line">bs += <span class="string">b'A'</span>*(<span class="number">0x60</span>)</span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line"></span><br><span class="line">print(b64e(bs)+<span class="string">' '</span>)</span><br></pre></td></tr></table></figure>
<p>若按照上一篇文章的bson结构去构造payload，即<code>&#39;CVC&#39;:111</code>，当payload大于一定长度时会导致不能到达以下分支，没法触发漏洞<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622191188255-1622191188256.png" alt="title"></p>
<p>原因是<code>copy_payload</code>的返回值不为0<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622191874009-1622191874010.png" alt="title"></p>
<p>让<code>copy_payload</code>执行到这个分支即可返回0，经过测试<code>&#39;CVC&#39;:545</code>能通过check<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622193008468-1622193008469.png" alt="title"></p>
<p>按以下方法构造bson序列，便能发送长字符串，并触发栈溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> bson</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line"></span><br><span class="line">obj = &#123;</span><br><span class="line">    <span class="string">'CVC'</span>:<span class="number">545</span>,</span><br><span class="line">    <span class="string">'MON'</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">'YR'</span>: <span class="number">2021</span></span><br><span class="line">&#125;</span><br><span class="line">bs = bson.dumps(obj)</span><br><span class="line"></span><br><span class="line">bs = bs[:<span class="number">-1</span>]</span><br><span class="line">bs += <span class="string">b'\x02'</span></span><br><span class="line">bs += <span class="string">b'CC'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += p32(<span class="number">0x10</span>)</span><br><span class="line">bs += <span class="string">b'A'</span>*(<span class="number">0x60</span>)</span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line"></span><br><span class="line">print(b64e(bs)+<span class="string">' '</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622193238128-1622193238129.png" alt="title"></p>
	

	</div>
  <a type="button" href="/2021/06/26/PWN掉一款小型开源OS——续篇：内核态PWN/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/242627" target="_blank" rel="noopener">PWN掉一款小型开源OS——续篇：内核态PWN</a></p>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/24/1621834179965-1621834179966.png" alt="title"><br>本篇文章是coooinbase这道题的内核态利用。作为上一篇文章<code>PWN掉一款小型开源OS——用户态利用</code>的续篇，本文将解决上文遗留下的一些问题，并分析从userland到kerneland的利用机会。</p>
<h1 id="遗留下的问题"><a href="#遗留下的问题" class="headerlink" title="遗留下的问题"></a>遗留下的问题</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> bson</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line"></span><br><span class="line">obj = &#123;</span><br><span class="line">    <span class="string">'CVC'</span>:<span class="number">111</span>,</span><br><span class="line">    <span class="string">'MON'</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">'YR'</span>: <span class="number">2021</span></span><br><span class="line">&#125;</span><br><span class="line">bs = bson.dumps(obj)</span><br><span class="line"></span><br><span class="line">bs = bs[:<span class="number">-1</span>]</span><br><span class="line">bs += <span class="string">b'\x02'</span></span><br><span class="line">bs += <span class="string">b'CC'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += p32(<span class="number">0x10</span>)</span><br><span class="line">bs += <span class="string">b'A'</span>*(<span class="number">0x60</span>)</span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line"></span><br><span class="line">print(b64e(bs)+<span class="string">' '</span>)</span><br></pre></td></tr></table></figure>
<p>若按照上一篇文章的bson结构去构造payload，即<code>&#39;CVC&#39;:111</code>，当payload大于一定长度时会导致不能到达以下分支，没法触发漏洞<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622191188255-1622191188256.png" alt="title"></p>
<p>原因是<code>copy_payload</code>的返回值不为0<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622191874009-1622191874010.png" alt="title"></p>
<p>让<code>copy_payload</code>执行到这个分支即可返回0，经过测试<code>&#39;CVC&#39;:545</code>能通过check<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622193008468-1622193008469.png" alt="title"></p>
<p>按以下方法构造bson序列，便能发送长字符串，并触发栈溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> bson</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">'aarch64'</span></span><br><span class="line"></span><br><span class="line">obj = &#123;</span><br><span class="line">    <span class="string">'CVC'</span>:<span class="number">545</span>,</span><br><span class="line">    <span class="string">'MON'</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">'YR'</span>: <span class="number">2021</span></span><br><span class="line">&#125;</span><br><span class="line">bs = bson.dumps(obj)</span><br><span class="line"></span><br><span class="line">bs = bs[:<span class="number">-1</span>]</span><br><span class="line">bs += <span class="string">b'\x02'</span></span><br><span class="line">bs += <span class="string">b'CC'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += p32(<span class="number">0x10</span>)</span><br><span class="line">bs += <span class="string">b'A'</span>*(<span class="number">0x60</span>)</span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line">bs += <span class="string">b'\x00'</span></span><br><span class="line"></span><br><span class="line">print(b64e(bs)+<span class="string">' '</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/28/1622193238128-1622193238129.png" alt="title"></p>
	
	</div>
  <a type="button" href="/2021/06/26/PWN掉一款小型开源OS——续篇：内核态PWN/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/06/26/PWN掉一款小型开源OS——用户态利用/" title="DefCon Quals 2021 coooinbase的解题思路">PWN掉一款小型开源OS——用户态利用</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-06-26  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/242112" target="_blank" rel="noopener">PWN掉一款小型开源OS——用户态利用</a></p>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621326290561-1621326290590.png" alt="title"><br>题目来源于DefCon Quals 2021的coooinbase二连pwn，第一部分是用户空间利用，第二部分是内核利用。本篇文章是coooinbase用户态pwn的解题思路。</p>
<p>在Github上找到对应源码<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621326380004-1621326380005.png" alt="title"></p>
<p>这是一款极其精简的的OS，没有shell，甚至只实现了有限的几个系统调用，包括open、read、write等。在<code>coooinbase.bin</code>这个内核基础上，再跑着一个用户态进程<code>run</code>，以下是关于<code>run</code>这个用户态进程的pwn<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621326468550-1621326468553.png" alt="title"></p>
<h1 id="Ruby源码审计"><a href="#Ruby源码审计" class="headerlink" title="Ruby源码审计"></a>Ruby源码审计</h1><p>给了以下几个文件，执行<code>ruby x.rb</code>启动题目环境<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621329312675-1621329312678.png" alt="title"></p>
<p>解压文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/dos</span><br><span class="line">sudo mount -o loop ./rootfs.img /tmp/dos</span><br><span class="line">file /tmp/dos/bin</span><br><span class="line">/tmp/dos/bin: PDP-11 kernel overlay</span><br><span class="line">cat /tmp/dos/flg</span><br><span class="line">OOO&#123;this_is_from_userland&#125;</span><br></pre></td></tr></table></figure>

<p>x.rb，会对输入的<code>credit_card</code>进行校验，看下是否valid，可用<code>4485-7873-4804-0088</code>通过检查<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/21/1621584844106-1621584844111.png" alt="title"></p>
<p>通过POST方法<code>/gen-bson</code>获取<code>cvv</code>、<code>expmonth</code>、<code>expyear</code>、<code>cardnumber</code>参数，序列化成bson数据，最后转成base64。但是，bson只能接受<code>0x0~0x7f</code>的utf-8数据，超出这个范围的byte数据会导致没法通过x.rb的check，这为后续构造rop带来困难。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/21/1621585746598-1621585746599.png" alt="title"></p>
	

	</div>
  <a type="button" href="/2021/06/26/PWN掉一款小型开源OS——用户态利用/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/242112" target="_blank" rel="noopener">PWN掉一款小型开源OS——用户态利用</a></p>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621326290561-1621326290590.png" alt="title"><br>题目来源于DefCon Quals 2021的coooinbase二连pwn，第一部分是用户空间利用，第二部分是内核利用。本篇文章是coooinbase用户态pwn的解题思路。</p>
<p>在Github上找到对应源码<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621326380004-1621326380005.png" alt="title"></p>
<p>这是一款极其精简的的OS，没有shell，甚至只实现了有限的几个系统调用，包括open、read、write等。在<code>coooinbase.bin</code>这个内核基础上，再跑着一个用户态进程<code>run</code>，以下是关于<code>run</code>这个用户态进程的pwn<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621326468550-1621326468553.png" alt="title"></p>
<h1 id="Ruby源码审计"><a href="#Ruby源码审计" class="headerlink" title="Ruby源码审计"></a>Ruby源码审计</h1><p>给了以下几个文件，执行<code>ruby x.rb</code>启动题目环境<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/18/1621329312675-1621329312678.png" alt="title"></p>
<p>解压文件系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tmp/dos</span><br><span class="line">sudo mount -o loop ./rootfs.img /tmp/dos</span><br><span class="line">file /tmp/dos/bin</span><br><span class="line">/tmp/dos/bin: PDP-11 kernel overlay</span><br><span class="line">cat /tmp/dos/flg</span><br><span class="line">OOO&#123;this_is_from_userland&#125;</span><br></pre></td></tr></table></figure>

<p>x.rb，会对输入的<code>credit_card</code>进行校验，看下是否valid，可用<code>4485-7873-4804-0088</code>通过检查<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/21/1621584844106-1621584844111.png" alt="title"></p>
<p>通过POST方法<code>/gen-bson</code>获取<code>cvv</code>、<code>expmonth</code>、<code>expyear</code>、<code>cardnumber</code>参数，序列化成bson数据，最后转成base64。但是，bson只能接受<code>0x0~0x7f</code>的utf-8数据，超出这个范围的byte数据会导致没法通过x.rb的check，这为后续构造rop带来困难。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/21/1621585746598-1621585746599.png" alt="title"></p>
	
	</div>
  <a type="button" href="/2021/06/26/PWN掉一款小型开源OS——用户态利用/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/06/26/借助DefCon-Quals-2021的mooosl学习musl-mallocng（漏洞利用篇）/" title="DefCon Quals 2021 mooosl的解题思路">借助DefCon Quals 2021的mooosl学习musl mallocng（漏洞利用篇）</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-06-26  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/241104" target="_blank" rel="noopener">借助DefCon Quals 2021的mooosl学习musl mallocng（漏洞利用篇）</a></p>
<p>上篇我们大致过了一遍musl libc 1.2.2的mallocng源码，了解到musl堆管理器用以下的结构管理着meta、group以及chunk。本篇我们继续来分析mooosl这道题的解题思路。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/13/1620877156490-1620877156490.png" alt="title"></p>
<h1 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h1><p>保护全开<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620961337503-1620961337534.png" alt="title"></p>
<p>程序主要提供了<code>store</code>、<code>query</code>、<code>delete</code>这几个功能，下面逐个功能进行分析<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620961459130-1620961459131.png" alt="title"></p>
<p>sotre，申请0x30的chunk，用于存放key、value以及对应的size，另外还会算出hash和prev_hash_map（保存着hash_map先前在该处的指针）<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620973183066-1620973183067.png" alt="title"></p>
<p>set_key和set_value，比较类似，根据输入的size去申请chunk，然后填入key和value，所以store方法一共会申请3个chunk<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620962248015-1620962248017.png" alt="title"></p>
<p>get_hash，返回一个hash值，返回后只取低12位，根据这个hash得到hash_map[hash&amp;0xfff]，先将hash_map[hash&amp;0xfff]原有的值保存在prev_hash_map，然后将0x30 chunk的地址存入hash_map[hash&amp;0xfff]<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620973758763-1620973758765.png" alt="title"></p>
<p>query，查询功能，根据输入的key，找到对应的value并以hex字符串形式输出。注意到这里调了set_key，会先申请chunk用于存放key，最后再free掉。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620973813101-1620973813103.png" alt="title"></p>
<p>查找过程是遍历hash_map找到对应key，如果prev_hash_map不为零，则会打印出prev_hash_map的数据<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620979440795-1620979440796.png" alt="title"></p>
	

	</div>
  <a type="button" href="/2021/06/26/借助DefCon-Quals-2021的mooosl学习musl-mallocng（漏洞利用篇）/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/241104" target="_blank" rel="noopener">借助DefCon Quals 2021的mooosl学习musl mallocng（漏洞利用篇）</a></p>
<p>上篇我们大致过了一遍musl libc 1.2.2的mallocng源码，了解到musl堆管理器用以下的结构管理着meta、group以及chunk。本篇我们继续来分析mooosl这道题的解题思路。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/13/1620877156490-1620877156490.png" alt="title"></p>
<h1 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h1><p>保护全开<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620961337503-1620961337534.png" alt="title"></p>
<p>程序主要提供了<code>store</code>、<code>query</code>、<code>delete</code>这几个功能，下面逐个功能进行分析<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620961459130-1620961459131.png" alt="title"></p>
<p>sotre，申请0x30的chunk，用于存放key、value以及对应的size，另外还会算出hash和prev_hash_map（保存着hash_map先前在该处的指针）<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620973183066-1620973183067.png" alt="title"></p>
<p>set_key和set_value，比较类似，根据输入的size去申请chunk，然后填入key和value，所以store方法一共会申请3个chunk<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620962248015-1620962248017.png" alt="title"></p>
<p>get_hash，返回一个hash值，返回后只取低12位，根据这个hash得到hash_map[hash&amp;0xfff]，先将hash_map[hash&amp;0xfff]原有的值保存在prev_hash_map，然后将0x30 chunk的地址存入hash_map[hash&amp;0xfff]<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620973758763-1620973758765.png" alt="title"></p>
<p>query，查询功能，根据输入的key，找到对应的value并以hex字符串形式输出。注意到这里调了set_key，会先申请chunk用于存放key，最后再free掉。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620973813101-1620973813103.png" alt="title"></p>
<p>查找过程是遍历hash_map找到对应key，如果prev_hash_map不为零，则会打印出prev_hash_map的数据<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/14/1620979440795-1620979440796.png" alt="title"></p>
	
	</div>
  <a type="button" href="/2021/06/26/借助DefCon-Quals-2021的mooosl学习musl-mallocng（漏洞利用篇）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/31/借助DefCon-Quals-2021的mooosl学习musl-mallocng（源码审计篇）/" title="DefCon Quals 2021 mooosl的解题思路">借助DefCon Quals 2021的mooosl学习musl mallocng（源码审计篇）</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-31  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/241101" target="_blank" rel="noopener">借助DefCon Quals 2021的mooosl学习musl mallocng（源码审计篇）</a></p>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/13/1620880732619-1620880732620.png" alt="title"><br>本题来源于DefCon Quals 2021的mooosl，考察点是最新版本musl libc 1.2.2利用。</p>
<p>关于musl libc的资料比赛期间找到过一篇<a href="https://www.anquanke.com/post/id/202253#h3-15" target="_blank" rel="noopener">从一次 CTF 出题谈 musl libc 堆漏洞利用</a>，碍于musl libc在1.2.x之后的堆管理机制有较大的改版，因而有了该文章。本次文章分上下两篇，从musl libc 1.2.2的源码审计、调试，以及其中的利用机会，再到mooosl这道题的解题过程做一个分析。</p>
<p>musl libc 1.2.2的源码可以从<a href="https://musl.libc.org/releases/musl-1.2.2.tar.gz" target="_blank" rel="noopener">此处</a>下载获得。1.2.x采用<code>src/malloc/mallocng</code>内的代码，其堆管理结构与早期版本几乎完全不同，而早期的堆管理器则放入了<code>src/malloc/oldmalloc</code>中。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/13/1620880937953-1620880937955.png" alt="title"></p>
<h1 id="调试带符号的musl-libc"><a href="#调试带符号的musl-libc" class="headerlink" title="调试带符号的musl libc"></a>调试带符号的musl libc</h1><h2 id="0x01源码编译"><a href="#0x01源码编译" class="headerlink" title="0x01源码编译"></a>0x01源码编译</h2><p>题目提供的libc.so不带符号，很难通过调试去理解musl堆管理器的数据结构，可以通过源码编译，生成一份带调试符号的libc.so，进行源码级debug。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf .&#x2F;musl-1.2.2.tar.gz</span><br><span class="line">cd musl-1.2.2</span><br><span class="line">mkdir build x64</span><br><span class="line">cd build</span><br><span class="line"></span><br><span class="line">CC&#x3D;&quot;gcc&quot; CXX&#x3D;&quot;g++&quot; \             </span><br><span class="line">    CFLAGS&#x3D;&quot;-g -g3 -ggdb -gdwarf-4 -Og -Wno-error -fno-stack-protector&quot; \</span><br><span class="line">    CXXFLAGS&#x3D;&quot;-g -g3 -ggdb -gdwarf-4 -Og -Wno-error -fno-stack-protector&quot; \</span><br><span class="line">    ..&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;sung3r&#x2F;workspace&#x2F;sharefd&#x2F;glibc&#x2F;glibc-2.32&#x2F;x64 --disable-werror</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>在<code>/src/x64/</code>下找到编译好的libc.so</p>
<p>通过patchelf将ld.so改成libc.so即可，gdb调试时加上<code>dir /path/to/musl-1.2.2/src/malloc/</code>和<code>dir /path/to/musl-1.2.2/src/malloc/mallocng</code>便可源码调试。</p>
	

	</div>
  <a type="button" href="/2021/05/31/借助DefCon-Quals-2021的mooosl学习musl-mallocng（源码审计篇）/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/241101" target="_blank" rel="noopener">借助DefCon Quals 2021的mooosl学习musl mallocng（源码审计篇）</a></p>
<p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/13/1620880732619-1620880732620.png" alt="title"><br>本题来源于DefCon Quals 2021的mooosl，考察点是最新版本musl libc 1.2.2利用。</p>
<p>关于musl libc的资料比赛期间找到过一篇<a href="https://www.anquanke.com/post/id/202253#h3-15" target="_blank" rel="noopener">从一次 CTF 出题谈 musl libc 堆漏洞利用</a>，碍于musl libc在1.2.x之后的堆管理机制有较大的改版，因而有了该文章。本次文章分上下两篇，从musl libc 1.2.2的源码审计、调试，以及其中的利用机会，再到mooosl这道题的解题过程做一个分析。</p>
<p>musl libc 1.2.2的源码可以从<a href="https://musl.libc.org/releases/musl-1.2.2.tar.gz" target="_blank" rel="noopener">此处</a>下载获得。1.2.x采用<code>src/malloc/mallocng</code>内的代码，其堆管理结构与早期版本几乎完全不同，而早期的堆管理器则放入了<code>src/malloc/oldmalloc</code>中。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/05/13/1620880937953-1620880937955.png" alt="title"></p>
<h1 id="调试带符号的musl-libc"><a href="#调试带符号的musl-libc" class="headerlink" title="调试带符号的musl libc"></a>调试带符号的musl libc</h1><h2 id="0x01源码编译"><a href="#0x01源码编译" class="headerlink" title="0x01源码编译"></a>0x01源码编译</h2><p>题目提供的libc.so不带符号，很难通过调试去理解musl堆管理器的数据结构，可以通过源码编译，生成一份带调试符号的libc.so，进行源码级debug。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf .&#x2F;musl-1.2.2.tar.gz</span><br><span class="line">cd musl-1.2.2</span><br><span class="line">mkdir build x64</span><br><span class="line">cd build</span><br><span class="line"></span><br><span class="line">CC&#x3D;&quot;gcc&quot; CXX&#x3D;&quot;g++&quot; \             </span><br><span class="line">    CFLAGS&#x3D;&quot;-g -g3 -ggdb -gdwarf-4 -Og -Wno-error -fno-stack-protector&quot; \</span><br><span class="line">    CXXFLAGS&#x3D;&quot;-g -g3 -ggdb -gdwarf-4 -Og -Wno-error -fno-stack-protector&quot; \</span><br><span class="line">    ..&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;sung3r&#x2F;workspace&#x2F;sharefd&#x2F;glibc&#x2F;glibc-2.32&#x2F;x64 --disable-werror</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>在<code>/src/x64/</code>下找到编译好的libc.so</p>
<p>通过patchelf将ld.so改成libc.so即可，gdb调试时加上<code>dir /path/to/musl-1.2.2/src/malloc/</code>和<code>dir /path/to/musl-1.2.2/src/malloc/mallocng</code>便可源码调试。</p>
	
	</div>
  <a type="button" href="/2021/05/31/借助DefCon-Quals-2021的mooosl学习musl-mallocng（源码审计篇）/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/05/21/hxpCTF2020-wisdom2：Ptrace参数未校验引发的SerenityOS内核提权/" title="hxpCTF2020 wisdom2的解题思路">hxpCTF2020 wisdom2：Ptrace参数未校验引发的SerenityOS内核提权</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-05-21  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/228782" target="_blank" rel="noopener">hxpCTF2020 wisdom2：Ptrace参数未校验引发的SerenityOS内核提权</a></p>
<p>本题来源于hxpCTF 2020的wisdom2，是36c3 wisdom的升级版<a href="https://www.anquanke.com/post/id/228782" target="_blank" rel="noopener">CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权</a>，该漏洞存在于serenityOS在2020年12月23日以前提交的版本。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/04/27/1619515380642-1619515380645.png" alt="title"><br>漏洞存在于sys$ptrace()与sys$sigreturn()方法，允许Userland修改Kerneland的寄存器，进一步可实现内核提权。通过修改eflags的IOPL标志位，可对系统I/O设备进行读写操作。</p>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line">Oops, I did it again. :^)</span><br><span class="line"></span><br><span class="line">This is commit # 4232874270015d940a2ba62c113bcf12986a2151 with the attached patch applied. Flag is in &#x2F;dev&#x2F;hdb.</span><br><span class="line"></span><br><span class="line">Note that the setup of this task is perhaps a bit shaky: If you don’t get a shell prompt within a few seconds after solving the proof of work, something is wrong. Each connection has a time limit of 10 minutes; you may contact us in case this causes problems for you.</span><br><span class="line"></span><br><span class="line">Download:</span><br><span class="line">wisdom2-c46f03732e9dceef.tar.xz (19.4 MiB)</span><br><span class="line"></span><br><span class="line">Connection:</span><br><span class="line">telnet 157.90.19.161 2323</span><br></pre></td></tr></table></figure>

<h1 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h1><p>拉取对应源码<a href="https://github.com/SerenityOS/serenity/tree/4232874270015d940a2ba62c113bcf12986a2151" target="_blank" rel="noopener">https://github.com/SerenityOS/serenity/tree/4232874270015d940a2ba62c113bcf12986a2151</a></p>
<p>按照<code>Documentation/BuildInstructions.md</code>安装依赖，并且编译Toolchain和Kernel</p>
<p>先打上patch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git apply &#x2F;path&#x2F;to&#x2F;hxp.patch</span><br></pre></td></tr></table></figure>

<p>编译Toolchain</p>
	

	</div>
  <a type="button" href="/2021/05/21/hxpCTF2020-wisdom2：Ptrace参数未校验引发的SerenityOS内核提权/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/228782" target="_blank" rel="noopener">hxpCTF2020 wisdom2：Ptrace参数未校验引发的SerenityOS内核提权</a></p>
<p>本题来源于hxpCTF 2020的wisdom2，是36c3 wisdom的升级版<a href="https://www.anquanke.com/post/id/228782" target="_blank" rel="noopener">CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权</a>，该漏洞存在于serenityOS在2020年12月23日以前提交的版本。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/04/27/1619515380642-1619515380645.png" alt="title"><br>漏洞存在于sys$ptrace()与sys$sigreturn()方法，允许Userland修改Kerneland的寄存器，进一步可实现内核提权。通过修改eflags的IOPL标志位，可对系统I/O设备进行读写操作。</p>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line">Oops, I did it again. :^)</span><br><span class="line"></span><br><span class="line">This is commit # 4232874270015d940a2ba62c113bcf12986a2151 with the attached patch applied. Flag is in &#x2F;dev&#x2F;hdb.</span><br><span class="line"></span><br><span class="line">Note that the setup of this task is perhaps a bit shaky: If you don’t get a shell prompt within a few seconds after solving the proof of work, something is wrong. Each connection has a time limit of 10 minutes; you may contact us in case this causes problems for you.</span><br><span class="line"></span><br><span class="line">Download:</span><br><span class="line">wisdom2-c46f03732e9dceef.tar.xz (19.4 MiB)</span><br><span class="line"></span><br><span class="line">Connection:</span><br><span class="line">telnet 157.90.19.161 2323</span><br></pre></td></tr></table></figure>

<h1 id="Build"><a href="#Build" class="headerlink" title="Build"></a>Build</h1><p>拉取对应源码<a href="https://github.com/SerenityOS/serenity/tree/4232874270015d940a2ba62c113bcf12986a2151" target="_blank" rel="noopener">https://github.com/SerenityOS/serenity/tree/4232874270015d940a2ba62c113bcf12986a2151</a></p>
<p>按照<code>Documentation/BuildInstructions.md</code>安装依赖，并且编译Toolchain和Kernel</p>
<p>先打上patch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git apply &#x2F;path&#x2F;to&#x2F;hxp.patch</span><br></pre></td></tr></table></figure>

<p>编译Toolchain</p>
	
	</div>
  <a type="button" href="/2021/05/21/hxpCTF2020-wisdom2：Ptrace参数未校验引发的SerenityOS内核提权/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/01/31/CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权/" title="HXP 36C3 CTF wisdom的解题思路">CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-01-31  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/228782" target="_blank" rel="noopener">CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权</a></p>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/13/1610505381037-1610505381039.png" alt="title"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line"></span><br><span class="line">I really, really like this lovingly handcrafted OS. It would be a shame if something happened to it…</span><br><span class="line"></span><br><span class="line">This is commit # fd06164fa0cee25ab69c701897de0a4bd03537d6 with the attached patch applied. Flag is in &#x2F;dev&#x2F;hdb.</span><br><span class="line"></span><br><span class="line">Note that the setup of this task is perhaps a bit shaky: If you don’t get a shell prompt within a few seconds after solving the proof of work, something is wrong. Each connection has a time limit of 5 minutes and 30 seconds of CPU time, whichever happens first; you may contact us in case this causes problems for you.</span><br><span class="line">Download:</span><br><span class="line"></span><br><span class="line">wisdom-601e2adb9f44b61f.tar.xz (9.5 MiB)</span><br><span class="line">Connection:</span><br><span class="line"></span><br><span class="line">nc 88.198.156.191 2323</span><br></pre></td></tr></table></figure>

<h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><p>编译过程参考<a href="https://sung3r.github.io/2021/01/31/%E7%BC%96%E8%AF%91SerenityOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" target="_blank" rel="noopener">编译SerenityOS操作系统</a>这篇笔记</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu 20.04</span><br><span class="line">gcc 10.2.0</span><br><span class="line">cmake 3.19.2</span><br></pre></td></tr></table></figure>

<p>编译exp，在<code>Userland/</code>放exp源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit .&#x2F;Userland&#x2F;test.cpp</span><br></pre></td></tr></table></figure>

<p>先执行一遍<code>../Meta/refresh-serenity-qtcreator.sh</code>，提示<code>Serenety root not set.</code>，设置<code>SERENITY_ROOT</code></p>
	

	</div>
  <a type="button" href="/2021/01/31/CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p>本文首发于安全客：<a href="https://www.anquanke.com/post/id/228782" target="_blank" rel="noopener">CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权</a></p>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/13/1610505381037-1610505381039.png" alt="title"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Description:</span><br><span class="line"></span><br><span class="line">I really, really like this lovingly handcrafted OS. It would be a shame if something happened to it…</span><br><span class="line"></span><br><span class="line">This is commit # fd06164fa0cee25ab69c701897de0a4bd03537d6 with the attached patch applied. Flag is in &#x2F;dev&#x2F;hdb.</span><br><span class="line"></span><br><span class="line">Note that the setup of this task is perhaps a bit shaky: If you don’t get a shell prompt within a few seconds after solving the proof of work, something is wrong. Each connection has a time limit of 5 minutes and 30 seconds of CPU time, whichever happens first; you may contact us in case this causes problems for you.</span><br><span class="line">Download:</span><br><span class="line"></span><br><span class="line">wisdom-601e2adb9f44b61f.tar.xz (9.5 MiB)</span><br><span class="line">Connection:</span><br><span class="line"></span><br><span class="line">nc 88.198.156.191 2323</span><br></pre></td></tr></table></figure>

<h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><p>编译过程参考<a href="https://sung3r.github.io/2021/01/31/%E7%BC%96%E8%AF%91SerenityOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" target="_blank" rel="noopener">编译SerenityOS操作系统</a>这篇笔记</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu 20.04</span><br><span class="line">gcc 10.2.0</span><br><span class="line">cmake 3.19.2</span><br></pre></td></tr></table></figure>

<p>编译exp，在<code>Userland/</code>放exp源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit .&#x2F;Userland&#x2F;test.cpp</span><br></pre></td></tr></table></figure>

<p>先执行一遍<code>../Meta/refresh-serenity-qtcreator.sh</code>，提示<code>Serenety root not set.</code>，设置<code>SERENITY_ROOT</code></p>
	
	</div>
  <a type="button" href="/2021/01/31/CVE-2019-20172：36C3 wisdom中的SerenityOS内核提权/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2021/01/31/编译SerenityOS操作系统/" title="SerenityOS编译步骤">编译SerenityOS操作系统</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2021-01-31  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<p><a href="https://github.com/SerenityOS/serenity" target="_blank" rel="noopener">SerenityOS</a>是一套用于x86计算机的图形化类Unix操作系统。为了解决hxp 36C3 CTF的wisdom这道题，首先需要编译出该系统，以下是编译步骤。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/31/1612088652182-1612088652218.png" alt="title"></p>
<h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu 20.04</span><br><span class="line">gcc 10.2.0</span><br><span class="line">cmake 3.19.2</span><br></pre></td></tr></table></figure>

<p>安装ubuntu的dependencies</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential curl libmpfr-dev libmpc-dev libgmp-dev e2fsprogs qemu-system-i386 qemu-utils</span><br></pre></td></tr></table></figure>

<p>保证gcc版本&gt;=10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ubuntu-toolchain-r&#x2F;test</span><br><span class="line">sudo apt install gcc-10 g++-10</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;gcc gcc &#x2F;usr&#x2F;bin&#x2F;gcc-10 100 --slave &#x2F;usr&#x2F;bin&#x2F;g++ g++ &#x2F;usr&#x2F;bin&#x2F;g++-10</span><br></pre></td></tr></table></figure>

<p>保证cmake版本&gt;=3.16，官网下载<code>3.19.2</code>最新版本编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bootstrap</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h1 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h1>
	

	</div>
  <a type="button" href="/2021/01/31/编译SerenityOS操作系统/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<p><a href="https://github.com/SerenityOS/serenity" target="_blank" rel="noopener">SerenityOS</a>是一套用于x86计算机的图形化类Unix操作系统。为了解决hxp 36C3 CTF的wisdom这道题，首先需要编译出该系统，以下是编译步骤。<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/31/1612088652182-1612088652218.png" alt="title"></p>
<h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ubuntu 20.04</span><br><span class="line">gcc 10.2.0</span><br><span class="line">cmake 3.19.2</span><br></pre></td></tr></table></figure>

<p>安装ubuntu的dependencies</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential curl libmpfr-dev libmpc-dev libgmp-dev e2fsprogs qemu-system-i386 qemu-utils</span><br></pre></td></tr></table></figure>

<p>保证gcc版本&gt;=10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ubuntu-toolchain-r&#x2F;test</span><br><span class="line">sudo apt install gcc-10 g++-10</span><br><span class="line">sudo update-alternatives --install &#x2F;usr&#x2F;bin&#x2F;gcc gcc &#x2F;usr&#x2F;bin&#x2F;gcc-10 100 --slave &#x2F;usr&#x2F;bin&#x2F;g++ g++ &#x2F;usr&#x2F;bin&#x2F;g++-10</span><br></pre></td></tr></table></figure>

<p>保证cmake版本&gt;=3.16，官网下载<code>3.19.2</code>最新版本编译</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;bootstrap</span><br><span class="line">make -j8</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<h1 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h1>
	
	</div>
  <a type="button" href="/2021/01/31/编译SerenityOS操作系统/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/05/01/某次强制关机后引发的血案/" title="记录Mac环境配置过程">某次强制关机后引发的血案</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-05-01  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h1 id="强制重启后无限菊花"><a href="#强制重启后无限菊花" class="headerlink" title="强制重启后无限菊花"></a>强制重启后无限菊花</h1><p>前两天将mac关闭，等半天没关上，索性直接强制重启了，等再开机的时候。。。奔溃了，一致卡在开机进度条。</p>
<p>后来基本上能尝试的方法都尝试了。。。大致这几种<br>1.开机按住<code>command + R</code>键，进入macOS恢复界面，打开终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#进入缓存目录</span><br><span class="line">$ cd &#x2F;Volumes&#x2F;Macintosh&#x2F;var&#x2F;db&#x2F;caches&#x2F;opendirectory&#x2F;</span><br><span class="line">#删除缓存数据库</span><br><span class="line">$ mv .&#x2F;mbr_cache .&#x2F;mar_cache-old</span><br></pre></td></tr></table></figure>
<p>不行。。。<br>2.重置PRAM：开机按住<code>Control+Command</code>并保持3秒，试了不行<br>3.重置NVRem：开机按住<code>Option+Command+R+P</code>并保持30秒，也不行<br>4.开机<code>Command+S</code>，出现命令行提示符后输入以下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -uw &#x2F; </span><br><span class="line">mv &#x2F;var&#x2F;db&#x2F;.AppleSetupDone &#x2F;var&#x2F;db&#x2F;.AppleSetupDone-old</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<p>依旧不行<br>5.开机按住<code>shift</code>，貌似安全模式，进去有safari能联网查资料，没用。。。<br>6.开机按住<code>D</code>，硬件自检，没检测到啥错误。。<br>7.开机按住<code>command + R</code>键，进入磁盘工具，急救，磁盘检测正常，没桃子用。。。<br>8.没法开机可以先试试这个方法<a href="https://support.apple.com/zh-cn/HT201295" target="_blank" rel="noopener">如何重置Mac的SMC</a></p>
<p>想起以前问过客服，没开启磁盘加密的情况下是能直接覆盖安装系统的，不需要抹除，数据不会丢失。就这样傻傻的花了一个多小时安装系统，重启过后，还是一样的情况。。。醉了，这办法也不灵了</p>
<p>没办法，直接抹除重装，先进恢复模式把重要资料搞出来，毕竟数据无价。在<code>磁盘工具-&gt;文件-&gt;新建映像-&gt;来自文件夹的映像...</code>选中需要保存的文件夹，后缀填dmg，存储到U盘或移动硬盘上。</p>
<p>一个多小时后。。。终于装好了，但所有的环境都丢失了。。。</p>
	

	</div>
  <a type="button" href="/2020/05/01/某次强制关机后引发的血案/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h1 id="强制重启后无限菊花"><a href="#强制重启后无限菊花" class="headerlink" title="强制重启后无限菊花"></a>强制重启后无限菊花</h1><p>前两天将mac关闭，等半天没关上，索性直接强制重启了，等再开机的时候。。。奔溃了，一致卡在开机进度条。</p>
<p>后来基本上能尝试的方法都尝试了。。。大致这几种<br>1.开机按住<code>command + R</code>键，进入macOS恢复界面，打开终端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#进入缓存目录</span><br><span class="line">$ cd &#x2F;Volumes&#x2F;Macintosh&#x2F;var&#x2F;db&#x2F;caches&#x2F;opendirectory&#x2F;</span><br><span class="line">#删除缓存数据库</span><br><span class="line">$ mv .&#x2F;mbr_cache .&#x2F;mar_cache-old</span><br></pre></td></tr></table></figure>
<p>不行。。。<br>2.重置PRAM：开机按住<code>Control+Command</code>并保持3秒，试了不行<br>3.重置NVRem：开机按住<code>Option+Command+R+P</code>并保持30秒，也不行<br>4.开机<code>Command+S</code>，出现命令行提示符后输入以下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mount -uw &#x2F; </span><br><span class="line">mv &#x2F;var&#x2F;db&#x2F;.AppleSetupDone &#x2F;var&#x2F;db&#x2F;.AppleSetupDone-old</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<p>依旧不行<br>5.开机按住<code>shift</code>，貌似安全模式，进去有safari能联网查资料，没用。。。<br>6.开机按住<code>D</code>，硬件自检，没检测到啥错误。。<br>7.开机按住<code>command + R</code>键，进入磁盘工具，急救，磁盘检测正常，没桃子用。。。<br>8.没法开机可以先试试这个方法<a href="https://support.apple.com/zh-cn/HT201295" target="_blank" rel="noopener">如何重置Mac的SMC</a></p>
<p>想起以前问过客服，没开启磁盘加密的情况下是能直接覆盖安装系统的，不需要抹除，数据不会丢失。就这样傻傻的花了一个多小时安装系统，重启过后，还是一样的情况。。。醉了，这办法也不灵了</p>
<p>没办法，直接抹除重装，先进恢复模式把重要资料搞出来，毕竟数据无价。在<code>磁盘工具-&gt;文件-&gt;新建映像-&gt;来自文件夹的映像...</code>选中需要保存的文件夹，后缀填dmg，存储到U盘或移动硬盘上。</p>
<p>一个多小时后。。。终于装好了，但所有的环境都丢失了。。。</p>
	
	</div>
  <a type="button" href="/2020/05/01/某次强制关机后引发的血案/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->
<div class="row">
	<div class="col-md-8">
		<h3 class="title">
			<a href="/2020/02/17/DefConCTF-Qualifier-2018-IPwnKit解题思路/" title="一道macOS内核题的解题思路">DefConCTF Qualifier 2018 IPwnKit解题思路</a>
		</h3>
		</div>
	<div class="col-md-4">
		<div class="date">post @ 2020-02-17  </div>
		</div>
	</div>
	


			<!--
<div class="entry">
  <div class="row">
	
	
		<h1 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h1><p>题目描述<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/31/1612101132633-1612101132849.png" alt="title"></p>
<p>defcon 2018资格赛的原题，题目文件给了一个kext IOKit内核扩展模块以及kernel二进制文件，先把环境搭起来。本地环境是macOS 10.14.6 Mojave (18G103)，安装KDK 10.14.2<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/31/1612101155018-1612101155023.png" alt="title"></p>
<p>为方便调试先关掉SIP，IPwnKit.kext复制到/System/Library/Extensions/，给权限，加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp IPwnKit.kext &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;</span><br><span class="line">sudo chown -R root:wheel &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;IPwnKit.kext</span><br><span class="line">sudo chmod -R 755 &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;IPwnKit.kext</span><br><span class="line">sudo kextload &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;IPwnKit.kext</span><br></pre></td></tr></table></figure>

<p>替换成macOS 10.14.2的内核</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp &#x2F;Library&#x2F;Developer&#x2F;KDKs&#x2F;KDK\_10.14.2\_18C54.kdk&#x2F;System&#x2F;Library&#x2F;Kernels&#x2F;kernel.development &#x2F;System&#x2F;Library&#x2F;Kernels&#x2F;kernel</span><br></pre></td></tr></table></figure>

<p>设置引导参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nvram boot-args&#x3D;&quot;debug&#x3D;0x141 kext-dev-mode&#x3D;1 kcsuffix&#x3D;development pmuflags&#x3D;1 -v&quot;</span><br><span class="line"></span><br><span class="line">sudo nvram boot-args&#x3D;&quot;debug&#x3D;0x144 kext-dev-mode&#x3D;1 kcsuffix&#x3D;development pmuflags&#x3D;1 -v&quot;</span><br></pre></td></tr></table></figure>

<p>1&gt;&gt;boot-args：系统的启动参<br>2&gt;&gt;debug=0×141，表示系统可以进行远程链接调试<br>3&gt;&gt;kext-dev-mode=1允许加载未签名kext<br>4&gt;&gt;kcsuffix=development 允许我们启动系统，通过development，与之前我们copy到/Systems/Library/Kernel下的kernel.development对应，如果我们之前拷贝的是kernel.debug，那么这里填kcsuffic=debug<br>5&gt;&gt;pmuflags=1关闭定时器<br>6&gt;&gt;-v显示内核加载信息.</p>
	

	</div>
  <a type="button" href="/2020/02/17/DefConCTF-Qualifier-2018-IPwnKit解题思路/#more" class="btn btn-default more">Read More</a>
</div>

-->
<div class="entry">
  <div class="row">
	
	
		<h1 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h1><p>题目描述<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/31/1612101132633-1612101132849.png" alt="title"></p>
<p>defcon 2018资格赛的原题，题目文件给了一个kext IOKit内核扩展模块以及kernel二进制文件，先把环境搭起来。本地环境是macOS 10.14.6 Mojave (18G103)，安装KDK 10.14.2<br><img src="https://raw.githubusercontent.com/sung3r/gitnote-images/main/gitnote-images/2021/01/31/1612101155018-1612101155023.png" alt="title"></p>
<p>为方便调试先关掉SIP，IPwnKit.kext复制到/System/Library/Extensions/，给权限，加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp IPwnKit.kext &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;</span><br><span class="line">sudo chown -R root:wheel &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;IPwnKit.kext</span><br><span class="line">sudo chmod -R 755 &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;IPwnKit.kext</span><br><span class="line">sudo kextload &#x2F;System&#x2F;Library&#x2F;Extensions&#x2F;IPwnKit.kext</span><br></pre></td></tr></table></figure>

<p>替换成macOS 10.14.2的内核</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp &#x2F;Library&#x2F;Developer&#x2F;KDKs&#x2F;KDK\_10.14.2\_18C54.kdk&#x2F;System&#x2F;Library&#x2F;Kernels&#x2F;kernel.development &#x2F;System&#x2F;Library&#x2F;Kernels&#x2F;kernel</span><br></pre></td></tr></table></figure>

<p>设置引导参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo nvram boot-args&#x3D;&quot;debug&#x3D;0x141 kext-dev-mode&#x3D;1 kcsuffix&#x3D;development pmuflags&#x3D;1 -v&quot;</span><br><span class="line"></span><br><span class="line">sudo nvram boot-args&#x3D;&quot;debug&#x3D;0x144 kext-dev-mode&#x3D;1 kcsuffix&#x3D;development pmuflags&#x3D;1 -v&quot;</span><br></pre></td></tr></table></figure>

<p>1&gt;&gt;boot-args：系统的启动参<br>2&gt;&gt;debug=0×141，表示系统可以进行远程链接调试<br>3&gt;&gt;kext-dev-mode=1允许加载未签名kext<br>4&gt;&gt;kcsuffix=development 允许我们启动系统，通过development，与之前我们copy到/Systems/Library/Kernel下的kernel.development对应，如果我们之前拷贝的是kernel.debug，那么这里填kcsuffic=debug<br>5&gt;&gt;pmuflags=1关闭定时器<br>6&gt;&gt;-v显示内核加载信息.</p>
	
	</div>
  <a type="button" href="/2020/02/17/DefConCTF-Qualifier-2018-IPwnKit解题思路/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">

   
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="Search" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>Categories</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/BIOS/">BIOS<span>1</span></a></li>
		
			<li><a href="/categories/Docs/">Docs<span>1</span></a></li>
		
			<li><a href="/categories/NBOS/">NBOS<span>2</span></a></li>
		
			<li><a href="/categories/SerenityOS/">SerenityOS<span>3</span></a></li>
		
			<li><a href="/categories/macOS/">macOS<span>1</span></a></li>
		
			<li><a href="/categories/musl-libc/">musl-libc<span>2</span></a></li>
		
		</ul>
	</div>

		
			
	<div class="widget">
		<h4>Tag Cloud</h4>
		<ul class="tag_box inline list-unstyled">		
		
			<li><a href="/tags/解题思路/">解题思路<span>8</span></a></li>
		
			<li><a href="/tags/环境配置/">环境配置<span>2</span></a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2021/06/26/解决第一个UEFI-PWN——Accessing-the-Truth解题思路/"  title="Pwn2Win CTF 2021 Accessing the Truth的解题思路" ><i class="fa fa-file-o"></i>解决第一个UEFI PWN——Accessing th...</a>
      </li>
    
      <li>
        <a href="/2021/06/26/PWN掉一款小型开源OS——续篇：内核态PWN/"  title="DefCon Quals 2021 coooinbase-kernel的解题思路" ><i class="fa fa-file-o"></i>PWN掉一款小型开源OS——续篇：内核态PWN</a>
      </li>
    
      <li>
        <a href="/2021/06/26/PWN掉一款小型开源OS——用户态利用/"  title="DefCon Quals 2021 coooinbase的解题思路" ><i class="fa fa-file-o"></i>PWN掉一款小型开源OS——用户态利用</a>
      </li>
    
      <li>
        <a href="/2021/06/26/借助DefCon-Quals-2021的mooosl学习musl-mallocng（漏洞利用篇）/"  title="DefCon Quals 2021 mooosl的解题思路" ><i class="fa fa-file-o"></i>借助DefCon Quals 2021的mooosl学...</a>
      </li>
    
      <li>
        <a href="/2021/05/31/借助DefCon-Quals-2021的mooosl学习musl-mallocng（源码审计篇）/"  title="DefCon Quals 2021 mooosl的解题思路" ><i class="fa fa-file-o"></i>借助DefCon Quals 2021的mooosl学...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/m0nshaw" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2021 m0nshaw's blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



</body>
   </html>
